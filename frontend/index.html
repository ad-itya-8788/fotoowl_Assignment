<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Import System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
    }

    .import-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 4px;
    }

    .import-section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #555;
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    input[type="text"] {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background: #0056b3;
    }

    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .images-section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #555;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th {
      background: #333;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: normal;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
      color: #333;
      vertical-align: middle;
    }

    tr:hover {
      background: #f9f9f9;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .storage-path {
      word-break: break-all;
      color: #007bff;
      font-size: 12px;
    }

    .pending {
      color: #999;
      font-style: italic;
    }

    .preview-img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    .preview-pending {
      width: 100px;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f0f0;
      border-radius: 4px;
      color: #999;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Scalable Image Import System</h1>

    <div class="import-section">
      <h2>Import Images from Google Drive</h2>
      <div class="input-group">
        <input 
          type="text" 
          id="folderUrl" 
          placeholder="Paste Google Drive folder URL here"
        />
        <button onclick="importImages()">Import</button>
      </div>
      <div id="status"></div>
    </div>

    <div class="images-section">
      <h2>Imported Images</h2>
      <button onclick="loadImages()">Refresh</button>
      <table>
        <thead>
          <tr>
            <th>Preview</th>
            <th>Name</th>
            <th>Google Drive ID</th>
            <th>Size (bytes)</th>
            <th>MIME Type</th>
            <th>Storage Path</th>
          </tr>
        </thead>
        <tbody id="imageTable">
          <tr>
            <td colspan="6" class="no-data">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    async function importImages() {
      const folderUrl = document.getElementById("folderUrl").value.trim();
      const statusDiv = document.getElementById("status");

      if (!folderUrl) {
        statusDiv.className = "status error";
        statusDiv.textContent = "Please enter a Google Drive folder URL";
        return;
      }

      statusDiv.className = "status info";
      statusDiv.textContent = "Importing images...";

      try {
        const response = await fetch("/import/google-drive", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ folderUrl })
        });

        const data = await response.json();

        if (response.ok) {
          statusDiv.className = "status success";
          statusDiv.textContent = `${data.message} - Total: ${data.totalImages}, Queued: ${data.queuedForDownload}`;
          setTimeout(loadImages, 2000);
        } else {
          statusDiv.className = "status error";
          statusDiv.textContent = `Error: ${data.error}`;
        }
      } catch (err) {
        statusDiv.className = "status error";
        statusDiv.textContent = `Error: ${err.message}`;
      }
    }

    async function loadImages() {
      const tableBody = document.getElementById("imageTable");
      tableBody.innerHTML = '<tr><td colspan="6" class="no-data">Loading...</td></tr>';

      try {
        const response = await fetch("/images");
        const images = await response.json();

        if (images.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="6" class="no-data">No images found</td></tr>';
          return;
        }

        tableBody.innerHTML = images.map(img => `
          <tr>
            <td>
              ${img.storage_path 
                ? `<img src="${img.storage_path}" alt="${img.name}" class="preview-img" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2212%22%3ENo Preview%3C/text%3E%3C/svg%3E'">` 
                : '<div class="preview-pending">‚è≥ Pending</div>'}
            </td>
            <td>${img.name}</td>
            <td>${img.google_drive_id}</td>
            <td>${img.size}</td>
            <td>${img.mime_type}</td>
            <td class="${img.storage_path ? 'storage-path' : 'pending'}">
              ${img.storage_path || 'Pending upload...'}
            </td>
          </tr>
        `).join('');

      } catch (err) {
        tableBody.innerHTML = `<tr><td colspan="6" class="no-data" style="color: red;">Error: ${err.message}</td></tr>`;
      }
    }

    window.onload = loadImages;
  </script>
</body>
</html>
